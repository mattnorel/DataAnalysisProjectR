---
title: "Analysis of Herrings Dataset"
output: 
  html_document:
    toc: true
    toc_float: true
author: "Piotr Kaszuba & Mateusz Norel"
date: "`r format(Sys.time(), '%d %B %Y')`"
params:
  dataset_name: "sledzie.csv"
  dataset_url: "http://www.cs.put.poznan.pl/alabijak/emd/projekt/sledzie.csv"
  na_chars: "?"
---

```{r markdown_setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Used Packages

Loading libaries:
```{r loading_libraries, results='hide', message=FALSE}
library("RCurl")
library(dplyr)
library(readr)
library(tidyr)
library(stringr)
library(knitr)
library(kableExtra)
library(mice)
library(VIM)
```
Listing of libraries loaded during code execution can be found in the cell below:
```{r printing_libraries, echo=FALSE}
s <- sessionInfo()
lib_str <- c()

for(p in s$loadedOnly){
  lib_str <- lib_str %>% append(p$Package)
}
str_c(lib_str, collapse=', ')
```
## Loading Data

Data is loded accoring to the metadata provided in the `params` object, where a location of a dataset (both local and url) is provided. Mentioned object contains also information about expected form of missing data. In this case 
```{r loading_data}
if(file.exists(params$dataset_name)) {
  dataset <- read.csv(params$dataset_name, na.strings = params$na_chars)
} else if(url.exists(params$dataset_url)){
  download.file(params$dataset_url, params$dataset_name)
  dataset <- read.csv(params$dataset_name, na.strings = params$na_chars)
} else {
  stop("There is no file nor url resource to work with!")
}
```

## Dataset
First sight at some rows from dataset will help us get better view on the data.
```{r}
head(dataset)
```

Here are names of all columns available in a raw dataset:
```{r}
dataset %>%
  colnames %>%
  print
```

After that dataset can be transferred to dyplr's `DataFrame` object.
By selecting just columns with `numeric` type and then checking if all column names match those from the raw set, we can make sure that all columns are ready for further work.
```{r}
herrings <- tbl_df(dataset)
herrings %>% 
  select_if(is.numeric) %>%
  colnames
```

It is also required to transform `xmonth` column to cathegorical, as its values are months.
```{r}
herrings <- herrings %>%
  mutate(xmonth = as.factor(xmonth))
```

## Missing Values
All columns were extracted correctly and do not contain anything different from numeric variables. But there are still missing values (`NA`s) in the dataframe. Before deciding what to do with them it is crucial to know how many rows have `NA` value.

We started with the list of columns that have at least one `NA` value.
```{r}
cols_with_na = c()
for(col in colnames(herrings)){
  if(any(is.na(herrings[col]))){
    cols_with_na <- cols_with_na %>% append(col)
  }
}
cols_with_na
```
There are `r length(cols_with_na)` such columns in herrings dataset. 
We decided to make another dataframe where all rows with `NA` value were omitted. It was done for the purpose of graphical analysis. Still regression was conducted on the dataset with values inputed in place of `NA`s. This imputation step was done in further cells.
```{r}
df_no_na <- na.omit(herrings)
```

Before making any decision about missing data it is important to somehow visualize it. It is recommended to not reconstruct variable if more than 5% of the data is not available. Also it is worth knowing missing data pattern. If it's random it is good idea to try some imputation methods. But if it seems that there is some reason for data being not available it's better to consider other methods (profound analysis of data gathering process is a way to start).

Following plots contains interesting information about missing data. It was done using VIM's `aggr` function on dataset with just those columns which contain at least `NA` value. Left figure, "Histogram of missing data" informs us how many values of each column are missing. We can see that it is around 3% of all values for each column. It is less than mentioned 5% so data reconstruction is worth considering. More than that, as all columns has around 3% missing data it is first hint that not availability might be caused by some random process. The right chart, "Missing data pattern", shows what is the pattern of missing data. All combinations of missing data were captured from the dataset and presented. Red color symbolizes `NA`, while blue indicate that correct value is available. Most common combinations are at the very bottom. Moving to the top there are less and less frequent combinations. 

It seems that there are no strong relations between missing values. Next step is an imputation.
```{r message=FALSE}
just_with_na <- herrings %>% select(cols_with_na)
aggr_plot <- aggr(just_with_na, col=c('navyblue','red'), numbers=FALSE, bars=TRUE, sortVars=TRUE, labels=names(just_with_na), cex.axis=.8, gap=3, ylab=c("Histogram of missing data","Missing data pattern"))
```

```{r}
head(herrings)
```

## Imputing Missing Data
```{r}
set.seed(17)
imputed <- mice(herrings,predictorMatrix = quickpred(herrings, exclude = c('sal')), meth='pmm', maxit=5)

```

```{r}
tmp_data <- complete(inputed,1)
head(mutate(tmp_data, sal = herrings$sal))
```

## Attribute-wise Analysis
```{r}
kable_styling(kable(summary(herrings)))

```

